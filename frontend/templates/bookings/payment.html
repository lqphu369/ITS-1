{% extends 'base.html' %}
{% load static %}

{% block title %}Thanh toán - ITS Rental{% endblock %}

{% block content %}
<div class="relative w-full min-h-[calc(100vh-64px)] overflow-x-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <div class="mb-8">
            <h1 class="text-3xl lg:text-4xl font-black tracking-tight mb-2 text-slate-900 dark:text-white">
                Thanh toán đặt xe
            </h1>
            <p class="text-slate-500 dark:text-slate-400 text-base">
                Hoàn tất đơn đặt xe cho chuyến đi sắp tới của bạn
            </p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 lg:gap-12 items-start">
            <div class="flex-1 w-full order-2 lg:order-1">
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 lg:p-8">
                    <div class="flex items-center gap-3 mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                        <span class="material-symbols-outlined text-primary text-2xl">lock</span>
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white">
                            Phương thức thanh toán
                        </h2>
                    </div>

                    <form method="POST" class="space-y-6">
                        {% csrf_token %}

                        <input type="hidden" name="pickup_date" value="{{ pickup_date|date:'Y-m-d' }}" />
                        <input type="hidden" name="return_date" value="{{ return_date|date:'Y-m-d' }}" />

                        <div class="flex flex-col sm:flex-row gap-4 mb-8">
                            <label class="flex-1 relative cursor-pointer group">
                                <input type="radio" name="payment_method" value="credit_card" class="peer sr-only" checked />
                                <div class="p-4 rounded-lg border-2 border-slate-200 dark:border-slate-700 peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all flex items-center gap-3">
                                    <span class="material-symbols-outlined text-2xl text-slate-500 dark:text-slate-400 peer-checked:text-primary">credit_card</span>
                                    <span class="font-medium text-slate-900 dark:text-white">Thẻ tín dụng</span>
                                    <span class="ml-auto material-symbols-outlined text-primary opacity-0 peer-checked:opacity-100">check_circle</span>
                                </div>
                            </label>

                            <label class="flex-1 relative cursor-pointer group">
                                <input type="radio" name="payment_method" value="e_wallet" class="peer sr-only" />
                                <div class="p-4 rounded-lg border-2 border-slate-200 dark:border-slate-700 peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50 transition-all flex items-center gap-3">
                                    <span class="material-symbols-outlined text-2xl text-slate-500 dark:text-slate-400 peer-checked:text-primary">account_balance_wallet</span>
                                    <span class="font-medium text-slate-900 dark:text-white">Ví điện tử</span>
                                    <span class="ml-auto material-symbols-outlined text-primary opacity-0 peer-checked:opacity-100">check_circle</span>
                                </div>
                            </label>
                        </div>

                        <div class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Số thẻ</label>
                                <div class="relative">
                                    <input type="text" placeholder="0000 0000 0000 0000" required class="w-full h-12 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 px-4 pl-12 text-base focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-gray-400 text-slate-900 dark:text-white" />
                                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">credit_card</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ngày hết hạn</label>
                                    <input type="text" placeholder="MM / YY" required class="w-full h-12 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-gray-400 text-slate-900 dark:text-white" />
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">CVV</label>
                                        <span class="material-symbols-outlined text-sm text-gray-400 cursor-help" title="3 chữ số ở mặt sau thẻ">help</span>
                                    </div>
                                    <input type="text" placeholder="123" required maxlength="3" class="w-full h-12 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-gray-400 text-slate-900 dark:text-white" />
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Tên chủ thẻ</label>
                                <input type="text" placeholder="NGUYEN VAN A" required class="w-full h-12 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 px-4 text-base focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all placeholder:text-gray-400 text-slate-900 dark:text-white uppercase" />
                            </div>
                        </div>

                        <div class="flex items-start gap-3 pt-2">
                            <div class="flex items-center h-5">
                                <input type="checkbox" id="billing" checked class="w-5 h-5 rounded border-gray-300 text-primary focus:ring-primary bg-slate-50 dark:bg-slate-900 dark:border-slate-700" />
                            </div>
                            <label for="billing" class="text-sm text-slate-600 dark:text-slate-300">
                                Địa chỉ thanh toán giống với địa chỉ trên GPLX
                            </label>
                        </div>

                        <div class="mt-8 flex flex-col sm:flex-row items-center gap-4">
                            <button type="submit" class="w-full sm:w-auto flex-1 h-14 bg-primary hover:bg-sky-600 text-white text-lg font-bold rounded-xl shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2">
                                <span>Xác nhận {{ final_total|floatformat:0 }}đ</span>
                                <span class="material-symbols-outlined">payments</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="w-full lg:w-[420px] order-1 lg:order-2">
                <div class="sticky top-24 space-y-6">
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-lg text-slate-900 dark:text-white">Tóm tắt đơn hàng</h3>
                            <a href="{% url 'frontend:vehicle_detail' vehicle.id %}" class="text-sm text-primary font-medium hover:underline">Sửa</a>
                        </div>

                        <div class="p-5">
                            <div class="relative w-full aspect-[16/9] rounded-lg overflow-hidden bg-slate-100 dark:bg-slate-900 mb-4 group">
                                <div class="w-full h-full bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                                     style="background-image: url('{% if vehicle.image %}{{ vehicle.image.url }}{% else %}{% static 'img/placeholder.jpg' %}{% endif %}');">
                                </div>
                            </div>

                            <div class="mb-6">
                                <h4 class="text-xl font-bold mb-1 text-slate-900 dark:text-white">
                                    {{ vehicle.name }}
                                </h4>
                                <p class="text-sm text-slate-500 dark:text-slate-400">
                                    {{ vehicle.get_vehicle_type_display }} • {{ vehicle.seats }} chỗ • {{ vehicle.fuel_display }}
                                </p>
                            </div>

                            <div class="flex flex-col gap-3 p-4 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-white dark:bg-slate-800 rounded-md border border-slate-200 dark:border-slate-700 shadow-sm">
                                            <span class="material-symbols-outlined text-primary text-sm">calendar_today</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold">Nhận xe</span>
                                            <span id="view-pickup" class="text-sm font-bold text-slate-900 dark:text-white">{{ pickup_date|date:"d/m/Y" }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 ml-5"></div>

                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-white dark:bg-slate-800 rounded-md border border-slate-200 dark:border-slate-700 shadow-sm">
                                            <span class="material-symbols-outlined text-primary text-sm">event_available</span>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold">Trả xe</span>
                                            <span id="view-return" class="text-sm font-bold text-slate-900 dark:text-white">{{ return_date|date:"d/m/Y" }}</span>
                                        </div>
                                    </div>
                                    <span class="text-xs font-medium bg-primary/10 text-primary px-2 py-1 rounded-full">{{ days }} ngày</span>
                                </div>
                            </div>

                            <div class="space-y-3 border-t border-slate-200 dark:border-slate-700 mt-4 pt-4">
                                {% if weekday_count > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600 dark:text-slate-400">Ngày thường ({{ vehicle.price_per_day|floatformat:0 }}đ x {{ weekday_count }})</span>
                                    <span class="font-medium text-slate-900 dark:text-white">{{ weekday_total|floatformat:0 }}đ</span>
                                </div>
                                {% endif %}

                                {% if weekend_count > 0 %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-amber-600 dark:text-amber-400 font-medium">
                                        Cuối tuần ({{ weekend_rate|floatformat:0 }}đ x {{ weekend_count }})
                                        <small class="block text-[10px] text-amber-500 uppercase font-bold">+20% Phụ phí cuối tuần</small>
                                    </span>
                                    <span class="font-semibold text-amber-700 dark:text-amber-300">{{ weekend_total|floatformat:0 }}đ</span>
                                </div>
                                {% endif %}

                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600 dark:text-slate-400">Thuế & phí dịch vụ (10%)</span>
                                    <span class="font-medium text-slate-900 dark:text-white">{{ tax_fee|floatformat:0 }}đ</span>
                                </div>

                                <div class="border-t border-slate-200 dark:border-slate-700 my-3 pt-3 flex justify-between items-end">
                                    <span class="font-bold text-base text-slate-900 dark:text-white">Tổng cộng</span>
                                    <span class="font-black text-2xl text-primary">{{ final_total|floatformat:0 }}đ</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-900 p-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex gap-2">
                                <span class="material-symbols-outlined text-green-600 text-lg">check_circle</span>
                                <p class="text-xs text-slate-600 dark:text-slate-400 leading-tight">
                                    Hủy miễn phí trước 48 giờ khi nhận xe.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get("action");

        if (action) {
            let newPickupDate = new Date();
            let noteMessage = "";

            if (action === "book_later") {
                newPickupDate.setDate(newPickupDate.getDate() + 1);
                noteMessage = "💡 Vì xe đang chạy, hệ thống đã chuyển ngày nhận sang Ngày mai.";
            } else if (action === "book_alternative") {
                newPickupDate.setDate(newPickupDate.getDate() + 3);
                noteMessage = "💡 Xe đang kín lịch, hệ thống gợi ý ngày trống gần nhất.";
            }

            let newReturnDate = new Date(newPickupDate);
            newReturnDate.setDate(newReturnDate.getDate() + 1);

            function formatDate(date, forInput = true) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, "0");
                const dd = String(date.getDate()).padStart(2, "0");
                return forInput ? `${yyyy}-${mm}-${dd}` : `${dd}/${mm}/${yyyy}`;
            }

            const inputPickup = document.querySelector('input[name="pickup_date"]');
            const inputReturn = document.querySelector('input[name="return_date"]');

            if (inputPickup) inputPickup.value = formatDate(newPickupDate, true);
            if (inputReturn) inputReturn.value = formatDate(newReturnDate, true);

            const viewPickup = document.getElementById("view-pickup");
            const viewReturn = document.getElementById("view-return");

            if (viewPickup) viewPickup.textContent = formatDate(newPickupDate, false);
            if (viewReturn) viewReturn.textContent = formatDate(newReturnDate, false);

            if (noteMessage) {
                const alertDiv = document.createElement("div");
                alertDiv.className = "bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded shadow-sm";
                alertDiv.innerHTML = `<p class="font-bold">Thay đổi tự động</p><p>${noteMessage}</p>`;
                const mainContainer = document.querySelector(".max-w-7xl");
                if (mainContainer) mainContainer.insertBefore(alertDiv, mainContainer.firstChild);
            }
        }
    });
</script>
{% endblock %}